# Simple workflow for deploying static content to GitHub Pages
name: Create ics files and deploy to Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:
  schedule:
    - cron: "0 20 * * *"

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # Single deploy job since we're just deploying
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Create export directory
        run: mkdir -p export

      - name: Generate all calendars
        run: |
          export OUTPUT_DIR="$(pwd)/export"
          swift run

      - name: List generated files
        run: ls -la export/

      - name: Generate index.html
        run: |
          # Z√≠skat aktu√°ln√≠ datum a ƒças v ƒçesk√© ƒçasov√© z√≥nƒõ
          export TZ=Europe/Prague
          CURRENT_TIME=$(date '+%d. %m. %Y v %H:%M')

          # Naƒç√≠st konfiguraci kalend√°≈ô≈Ø z JSON
          CALENDARS_JSON=$(cat config.json)

          cat > export/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="cs">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
            <meta http-equiv="Pragma" content="no-cache">
            <meta http-equiv="Expires" content="0">
            <title>Hokejov√© kalend√°≈ôe HC Beroun</title>
            <style>
              body { font-family: 'Segoe UI', Tahoma, Verdana, sans-serif; max-width:900px; margin:40px auto; padding:20px; background:#f5f7fa; color:#2c3e50; }
              h1 { text-align:center; color:#2980b9; border-bottom:3px solid #3498db; padding-bottom:10px; margin-bottom:30px; }
              .calendar-item { background:#fff; border-radius:8px; padding:15px; margin-bottom:20px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
              .header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
              .name { font-weight:600; font-size:1.1em; color:#2c3e50; }
              .buttons { display:flex; gap:8px; margin-top:8px; }
              .btn { padding:8px 12px; text-decoration:none; color:#fff; border-radius:4px; font-size:0.9em; white-space:nowrap; }
              .subscribe { background:#27ae60; }
              .subscribe:hover { background:#229954; }
              .google { background:#db4437; }
              .google:hover { background:#c23321; }
              .calendar-view { background:#3498db; }
              .calendar-view:hover { background:#2980b9; }
              .url-section { display:flex; gap:8px; align-items:center; margin-top:12px; flex-wrap:wrap; }
              .url { font-family:monospace; background:#f8f9fa; padding:8px; border:1px solid #ddd; border-radius:4px; flex-grow:1; word-break:break-all; font-size:0.85em; }
              .copy { background:#6c757d; border:none; color:#fff; padding:8px 12px; border-radius:4px; cursor:pointer; font-size:0.9em; }
              .copy.copied { background:#28a745; }
              .note { background:#fff3cd; border-left:4px solid #ffc107; padding:12px; border-radius:4px; margin-bottom:20px; }
              .note h3 { margin-top:0; color:#856404; }
              .instructions { background:#e8f5e8; border-left:4px solid #27ae60; padding:12px; border-radius:4px; margin-bottom:20px; }
              .instructions h3 { margin-top:0; color:#27ae60; }
              .last { text-align:center; color:#95a5a6; font-size:0.9em; margin-top:30px; }
              @media(max-width:600px){ .header { flex-direction:column; align-items:flex-start; } .buttons{margin-top:4px;} .url-section{flex-direction:column;} }
            </style>
            <script>
            function copyToClipboard(txt,btn){ navigator.clipboard.writeText(txt).then(()=>{ btn.textContent='Zkop√≠rov√°no!'; btn.classList.add('copied'); setTimeout(()=>{btn.textContent='Kop√≠rovat';btn.classList.remove('copied');},2000); }); }
            </script>
          </head>
          <body>
            <h1>üèí Hokejov√© kalend√°≈ôe HC Beroun</h1>
            
            <div class="instructions">
              <h3>üì± Jak p≈ôidat kalend√°≈ô:</h3>
              <ul>
                <li><strong>Odeb√≠rat kalend√°≈ô:</strong> Kliknƒõte na ‚ÄûOdeb√≠rat" ‚Äì automatick√© aktualizace (iOS, macOS, Outlook)</li>
                <li><strong>P≈ôidat do Google:</strong> Kliknƒõte na ‚ÄûP≈ôidat do Google" ‚Äì p≈ôid√° do Google kalend√°≈ôe (web)</li>
                <li><strong>Zobrazit kalend√°≈ô:</strong> Kliknƒõte na ‚ÄûZobrazit kalend√°≈ô" ‚Äì zobraz√≠ se n√°hled kalend√°≈ôe na webu</li>
                <li><strong>Kop√≠rovat URL:</strong> Pro manu√°ln√≠ import do libovoln√© aplikace</li>
              </ul>
            </div>

            <div class="note">
              <h3>ü§ñ Pro Android u≈æivatele:</h3>
              <p>
                Odkazy ‚ÄûOdeb√≠rat" na Androidu obvykle nefunguj√≠ a ani nen√≠ mo≈æn√© p≈ôidat kalend√°≈ô p≈ôes Google Kalend√°≈ô aplikaci v telefonu.
                Je pot≈ôeba se p≈ôihl√°sit do Google Kalend√°≈ôe p≈ôes web (a≈• u≈æ v mobilu nebo poƒç√≠taƒçi) a pak si vybran√Ω kalend√°≈ô p≈ôidat pomoc√≠ tlaƒç√≠tka "P≈ôidat do Google".
              </p>
            </div>
          EOF
          
          # Generovat kalend√°≈ôe z JSON konfigurace
          echo "$CALENDARS_JSON" | jq -c '.[]' | while read -r calendar; do
            filename=$(echo "$calendar" | jq -r '.filename')
            title=$(echo "$calendar" | jq -r '.title')
            googleID=$(echo "$calendar" | jq -r '.googleID')
            
            # URL kalend√°≈ôe
            calendar_url="https://ondrejstasek.github.io/hokej-rozpis/${filename}.ics"
            
            # Google Calendar URL - pokud je googleID pr√°zdn√©, pou≈æije se addbyurl
            if [ "$googleID" = "" ]; then
              google_url="https://calendar.google.com/calendar/u/0/r/addbyurl?cid=${calendar_url}"
            else
              google_url="https://calendar.google.com/calendar/u/0/r?cid=${googleID}"
            fi
            
            cat >> export/index.html << EOF
            <div class='calendar-item'>
              <div class='header'>
                <div class='name'>${title}</div>
                <div class='buttons'>
                  <a href='webcal://${calendar_url}' class='btn subscribe'>Odeb√≠rat</a>
                  <a href='${google_url}' class='btn google' target='_blank'>P≈ôidat do Google</a>
                  <a href='https://calendar.google.com/calendar/embed?src=${googleID}&ctz=Europe/Prague' class='btn calendar-view' target='_blank'>Zobrazit kalend√°≈ô</a>
                </div>
              </div>
              <div class='url-section'>
                <div class='url'>${calendar_url}</div>
                <button class='copy' onclick="copyToClipboard('${calendar_url}',this)">Kop√≠rovat</button>
              </div>
            </div>
          EOF
          done
          
          cat >> export/index.html << EOF
          <div class='last'>Kalend√°≈ôe byly naposledy aktualizov√°ny: ${CURRENT_TIME}</div>
          </body>
          </html>
          EOF
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'export'
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4